- This specific query returns the output of the average amount paid by the top 5 customers using a subquery (total_amount_paid) and a VIEW (top_10_cities) from a previous query.
##SQL Code

SELECT AVG (top_5_paying_customers) AS average_amount_paid_by_top_5_customers
FROM(
SELECT
A.customer_id,
A.first_name AS top_5_customer_name,
A.last_name AS top_5_customer_last_name,
D.country AS top_10_countries,
C.city AS top_10_cities,
SUM (E.amount) AS top_5_paying_customers
FROM customer A
INNER JOIN address B ON A.address_id=B.address_id
INNER JOIN city C ON B.city_id=C.city_id
INNER JOIN country D ON C.country_id=D.country_id
INNER JOIN payment E ON A.customer_id=E.customer_id
WHERE C.city IN (SELECT top_10_cities FROM top_10_cities_view
GROUP BY A.customer_id, D.country, C.city
ORDER BY SUM(E.amount) DESC
LIMIT 5) AS total_amount_paid;


- The next query returns the top 5 customers from the code above based within each country

##SQL Code

SELECT
    D.country,
COUNT(DISTINCT A.customer_id) AS all_customer_count,
COUNT(DISTINCT top_customers.customer_id) AS top_customers_count
FROM customer A
INNER JOIN address B ON A.address_id=B.address_id
INNER JOIN city C ON B.city_id=C.city_id
INNER JOIN country D ON C.country_id=D.country_id
LEFT JOIN
(SELECT
A.customer_id,
A.first_name AS top_5_customer_name,
A.last_name AS top_5_customer_last_name,
D.country AS top_10_countries,
C.city AS top_10_cities,
SUM (E.amount) AS top_5_paying_customers
FROM customer A
INNER JOIN address B ON A.address_id=B.address_id
INNER JOIN city C ON B.city_id=C.city_id
INNER JOIN country D ON C.country_id=D.country_id
INNER JOIN payment E ON A.customer_id=E.customer_id
WHERE C.city IN (SELECT top_10_cities FROM top_10_cities_view)
GROUP BY A.customer_id, D.country, C.city
ORDER BY SUM(E.amount) DESC
LIMIT 5) AS top_customers ON top_customers.top_10_countries=D.country
GROUP BY D.country
ORDER BY top_customer_count DESC;
