Below an example of a Common Table Expression (CTE) using the WITH syntax in a PostgreSQL database.

- This specific query returns the average amount paid by the top 5 customers in a film-related data-set.

##SQL Code

WITH total_amount_paid_cte AS
(SELECT
A.customer_id,
A.first_name AS top_5_customer_name,
A.last_name AS top_5_customer_last_name,
D.country AS top_10_countries,
C.city AS top_10_cities,
SUM (E.amount) AS top_5_paying_customers
FROM customer A
INNER JOIN address B ON A.address_id=B.address_id
INNER JOIN city C ON B.city_id=C.city_id
INNER JOIN country D ON C.country_id=D.country_id
INNER JOIN payment E ON A.customer_id=E.customer_id
WHERE C.city IN (SELECT top_10_cities FROM top_10_cities_view
GROUP BY A.customer_id, D.country, C.city
ORDER BY SUM(E.amount) DESC
LIMIT 5) 
SELECT AVG (top_5_paying_customers) AS average_amount_paid_top_5_customers
FROM total_amount_paid_cte;

- And below a similar query that returns the top 5 customers based within each country using a cte:

##SQL Code 

WITH total_amount_paid_cte AS
(SELECT
A.customer_id,
A.first_name AS top_5_customer_name,
A.last_name AS top_5_customer_last_name,
D.country AS top_10_countries,
C.city AS top_10_cities,
SUM (E.amount) AS top_5_paying_customers
FROM customer A
INNER JOIN address B ON A.address_id=B.address_id
INNER JOIN city C ON B.city_id=C.city_id
INNER JOIN country D ON C.country_id=D.country_id
INNER JOIN payment E ON A.customer_id=E.customer_id
WHERE C.city IN (SELECT top_10_cities FROM top_10_cities_view
GROUP BY A.customer_id, D.country, C.City
ORDER BY SUM(E.amount) DESC
LIMIT 5) 
SELECT
D.country, 
COUNT(DISTINCT A.customer_id) AS all_customer_count,
COUNT(DISTINCT top_customers.customer_id) AS top_customers_count
FROM customer A
INNER JOIN address B ON A.address_id=B.address_id
INNER JOIN city C ON B.city_id=C.city_id
INNER JOIN country D ON C.country_id=D.country_id
LEFT JOIN total_amount_paid_cte ON total_amount_paid_cte.top_10_countries=D.country
GROUP BY D.country
ORDER BY top_customers_count DESC;
